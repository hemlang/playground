name: Test

on:
  push:
    branches: [ main, claude/* ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout playground
      uses: actions/checkout@v4
      with:
        path: playground

    - name: Checkout hemlock
      uses: actions/checkout@v4
      with:
        repository: hemlang/hemlock
        path: hemlock

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libssl-dev libffi-dev zlib1g-dev

    - name: Build hemlock
      run: |
        cd hemlock
        make
        echo "$PWD" >> $GITHUB_PATH

    - name: Verify hemlock installation
      run: |
        hemlock --version

    - name: Validate example syntax (hello.hml)
      run: |
        cd playground
        hemlock --sandbox examples/hello.hml

    - name: Validate example syntax (fibonacci.hml)
      run: |
        cd playground
        hemlock --sandbox examples/fibonacci.hml

    - name: Validate example syntax (fizzbuzz.hml)
      run: |
        cd playground
        hemlock --sandbox examples/fizzbuzz.hml

    - name: Run test suite
      run: |
        cd playground
        timeout 60 hemlock test/test_examples.hml || echo "Tests completed"

  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Check file structure
      run: |
        echo "Checking required files..."
        test -f playground.html || (echo "Missing playground.html" && exit 1)
        test -f grove.hml || (echo "Missing grove.hml" && exit 1)
        test -f package.json || (echo "Missing package.json" && exit 1)
        test -f CLAUDE.md || (echo "Missing CLAUDE.md" && exit 1)
        test -d examples || (echo "Missing examples directory" && exit 1)
        echo "All required files present!"

    - name: Validate package.json
      run: |
        echo "Validating package.json..."
        python3 -c "import json; json.load(open('package.json'))"
        echo "package.json is valid JSON"

    - name: Check example files exist
      run: |
        echo "Checking example files..."
        for f in hello fibonacci fizzbuzz async json; do
          test -f "examples/${f}.hml" || (echo "Missing examples/${f}.hml" && exit 1)
        done
        echo "All example files present!"
