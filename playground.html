<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hemlock Playground üå≤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #1a1b26;
            --bg-darker: #16161e;
            --bg-lighter: #24283b;
            --text: #a9b1d6;
            --text-dim: #565f89;
            --accent: #7aa2f7;
            --accent-green: #9ece6a;
            --accent-red: #f7768e;
            --accent-yellow: #e0af68;
            --accent-purple: #bb9af7;
            --border: #3b4261;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: var(--bg-darker);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .logo-icon {
            font-size: 1.5rem;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            background: var(--bg-lighter);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        button:hover {
            background: var(--border);
        }

        button.primary {
            background: var(--accent);
            color: var(--bg-dark);
            border-color: var(--accent);
        }

        button.primary:hover {
            background: #8fb0fa;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .main-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .editor-pane, .output-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-pane {
            border-right: 1px solid var(--border);
        }

        .pane-header {
            background: var(--bg-darker);
            padding: 8px 16px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
        }

        #editor {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            color: transparent;
            caret-color: var(--text);
            border: none;
            padding: 16px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
            tab-size: 4;
            z-index: 1;
        }

        #editor::placeholder {
            color: var(--text-dim);
        }

        .output-container {
            flex: 1;
            overflow: auto;
            padding: 16px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .output-stdout {
            color: var(--text);
        }

        .output-stderr {
            color: var(--accent-red);
        }

        .output-info {
            color: var(--text-dim);
            font-style: italic;
        }

        .output-success {
            color: var(--accent-green);
        }

        .output-error {
            color: var(--accent-red);
        }

        .status-bar {
            background: var(--bg-darker);
            border-top: 1px solid var(--border);
            padding: 6px 16px;
            font-size: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-dim);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
        }

        .status-dot.error {
            background: var(--accent-red);
        }

        .status-dot.running {
            background: var(--accent-yellow);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .examples-dropdown {
            position: relative;
        }

        .examples-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: var(--bg-darker);
            border: 1px solid var(--border);
            border-radius: 6px;
            min-width: 200px;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .examples-menu.show {
            display: block;
        }

        .examples-menu button {
            width: 100%;
            background: transparent;
            border: none;
            border-radius: 0;
            text-align: left;
            padding: 10px 14px;
        }

        .examples-menu button:hover {
            background: var(--bg-lighter);
        }

        .examples-menu button:first-child {
            border-radius: 6px 6px 0 0;
        }

        .examples-menu button:last-child {
            border-radius: 0 0 6px 6px;
        }

        .keyboard-hint {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-left: 8px;
        }

        /* Syntax highlighting */
        .editor-wrapper {
            position: relative;
            flex: 1;
            overflow: hidden;
            background: var(--bg-dark);
            display: flex;
        }

        #line-numbers {
            padding: 16px 8px 16px 16px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-dim);
            text-align: right;
            user-select: none;
            background: var(--bg-darker);
            border-right: 1px solid var(--border);
            overflow: hidden;
            min-width: 40px;
        }

        .editor-content {
            position: relative;
            flex: 1;
            overflow: hidden;
        }

        #highlight {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 16px;
            margin: 0;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow: auto;
            pointer-events: none;
            background: transparent;
            border: none;
            tab-size: 4;
            color: var(--text);
        }

        /* Token colors - Tokyo Night theme */
        .tok-keyword { color: var(--accent-purple); }
        .tok-string { color: var(--accent-green); }
        .tok-number { color: var(--accent-yellow); }
        .tok-comment { color: var(--text-dim); font-style: italic; }
        .tok-function { color: var(--accent); }
        .tok-builtin { color: #7dcfff; }
        .tok-operator { color: #89ddff; }
        .tok-punctuation { color: var(--text-dim); }
        .tok-constant { color: var(--accent-yellow); }
        .tok-module { color: #bb9af7; }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <span class="logo-icon">üå≤</span>
            <span>Hemlock Playground</span>
        </div>
        <div class="toolbar">
            <div class="examples-dropdown">
                <button id="examples-btn">
                    üìö Examples
                    <span style="font-size: 0.7em;">‚ñº</span>
                </button>
                <div class="examples-menu" id="examples-menu">
                    <button data-example="hello">Hello World</button>
                    <button data-example="fibonacci">Fibonacci</button>
                    <button data-example="fizzbuzz">FizzBuzz</button>
                    <button data-example="async">Async/Await</button>
                    <button data-example="json">JSON Parsing</button>
                </div>
            </div>
            <button id="check-btn">
                ‚úì Check
                <span class="keyboard-hint">Ctrl+Shift+Enter</span>
            </button>
            <button id="run-btn" class="primary">
                ‚ñ∂ Run
                <span class="keyboard-hint">Ctrl+Enter</span>
            </button>
        </div>
    </header>

    <div class="main-container">
        <div class="editor-pane">
            <div class="pane-header">main.hml</div>
            <div class="editor-wrapper">
                <div id="line-numbers">1</div>
                <div class="editor-content">
                    <pre id="highlight" aria-hidden="true"></pre>
                    <textarea id="editor" placeholder="// Write your Hemlock code here..." spellcheck="false"></textarea>
                </div>
            </div>
        </div>
        <div class="output-pane">
            <div class="pane-header">Output</div>
            <div class="output-container" id="output">
                <span class="output-info">Press Run to execute your code...</span>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-item">
            <span class="status-dot" id="status-dot"></span>
            <span id="status-text">Ready</span>
        </div>
        <div class="status-item">
            <span id="version-info">Hemlock Playground v1.0</span>
        </div>
    </div>

    <script>
        // Hemlock Syntax Highlighter
        const Highlighter = {
            keywords: new Set([
                'if', 'else', 'for', 'while', 'return', 'break', 'continue',
                'fn', 'async', 'await', 'spawn', 'let', 'import', 'from',
                'try', 'catch', 'in'
            ]),
            constants: new Set(['true', 'false', 'null']),
            builtins: new Set([
                'print', 'print_ln', 'length', 'push', 'pop', 'shift',
                'join', 'split', 'substr', 'char_at', 'find', 'contains',
                'keys', 'values', 'parse', 'stringify', 'i32', 'rune'
            ]),

            // Tokenize and highlight code
            highlight(code) {
                let result = '';
                let i = 0;
                let lastKeyword = null;  // Track fn/async for function declarations

                while (i < code.length) {
                    // Comments
                    if (code[i] === '/' && code[i + 1] === '/') {
                        let end = code.indexOf('\n', i);
                        if (end === -1) end = code.length;
                        result += this.span('comment', this.esc(code.slice(i, end)));
                        i = end;
                        continue;
                    }

                    // Strings (double-quoted)
                    if (code[i] === '"') {
                        let j = i + 1;
                        while (j < code.length && code[j] !== '"') {
                            if (code[j] === '\\') j++;
                            j++;
                        }
                        result += this.span('string', this.esc(code.slice(i, j + 1)));
                        i = j + 1;
                        continue;
                    }

                    // Template strings (backtick)
                    if (code[i] === '`') {
                        let j = i + 1;
                        let str = '`';
                        while (j < code.length && code[j] !== '`') {
                            if (code[j] === '$' && code[j + 1] === '{') {
                                // Highlight up to ${
                                result += this.span('string', this.esc(str));
                                result += this.span('punctuation', '${');
                                j += 2;
                                str = '';
                                // Find matching } (simple, no nesting)
                                let depth = 1;
                                let expr = '';
                                while (j < code.length && depth > 0) {
                                    if (code[j] === '{') depth++;
                                    else if (code[j] === '}') depth--;
                                    if (depth > 0) expr += code[j];
                                    j++;
                                }
                                result += this.highlight(expr);
                                result += this.span('punctuation', '}');
                                continue;
                            }
                            if (code[j] === '\\') {
                                str += code[j++];
                            }
                            str += code[j++];
                        }
                        str += '`';
                        result += this.span('string', this.esc(str));
                        i = j + 1;
                        continue;
                    }

                    // Numbers
                    if (/[0-9]/.test(code[i]) || (code[i] === '.' && /[0-9]/.test(code[i + 1]))) {
                        let j = i;
                        while (j < code.length && /[0-9.eE\-]/.test(code[j])) j++;
                        result += this.span('number', code.slice(i, j));
                        i = j;
                        continue;
                    }

                    // Identifiers and keywords
                    if (/[a-zA-Z_]/.test(code[i])) {
                        let j = i;
                        while (j < code.length && /[a-zA-Z0-9_]/.test(code[j])) j++;
                        const word = code.slice(i, j);

                        if (this.keywords.has(word)) {
                            result += this.span('keyword', word);
                            lastKeyword = word;
                        } else if (this.constants.has(word)) {
                            result += this.span('constant', word);
                            lastKeyword = null;
                        } else if (this.builtins.has(word)) {
                            result += this.span('builtin', word);
                            lastKeyword = null;
                        } else if (lastKeyword === 'fn' || lastKeyword === 'async') {
                            // Function declaration (name after fn/async fn)
                            result += this.span('function', word);
                            lastKeyword = null;
                        } else if (code[j] === '(') {
                            // Function call
                            result += this.span('function', word);
                            lastKeyword = null;
                        } else {
                            result += this.esc(word);
                            lastKeyword = null;
                        }
                        i = j;
                        continue;
                    }

                    // Module paths @stdlib/...
                    if (code[i] === '@') {
                        let j = i;
                        while (j < code.length && /[a-zA-Z0-9_\/@]/.test(code[j])) j++;
                        result += this.span('module', this.esc(code.slice(i, j)));
                        i = j;
                        continue;
                    }

                    // Operators
                    if ('+-*/%=<>!&|'.includes(code[i])) {
                        let op = code[i];
                        if (code[i + 1] && '=&|'.includes(code[i + 1])) {
                            op += code[++i];
                        }
                        result += this.span('operator', this.esc(op));
                        i++;
                        continue;
                    }

                    // Punctuation
                    if ('(){}[];:,.'.includes(code[i])) {
                        result += this.span('punctuation', this.esc(code[i]));
                        i++;
                        continue;
                    }

                    // Whitespace and other
                    result += this.esc(code[i]);
                    i++;
                }

                return result;
            },

            span(type, content) {
                return `<span class="tok-${type}">${content}</span>`;
            },

            esc(str) {
                return str.replace(/&/g, '&amp;')
                          .replace(/</g, '&lt;')
                          .replace(/>/g, '&gt;');
            }
        };

        // Configuration - auto-detect API URL from current location
        const API_URL = window.location.origin;

        // Example programs (using correct Hemlock syntax)
        const EXAMPLES = {
            hello: [
                '// Hello World in Hemlock',
                'fn main() {',
                '    print("Hello, World!");',
                '    print("Welcome to Hemlock!");',
                '}',
                '',
                'main();'
            ].join('\n'),

            fibonacci: [
                '// Fibonacci sequence',
                'fn fib(n) {',
                '    if (n <= 1) {',
                '        return n;',
                '    }',
                '    return fib(n - 1) + fib(n - 2);',
                '}',
                '',
                'fn main() {',
                '    print("Fibonacci sequence:");',
                '    for (let i = 0; i < 15; i = i + 1) {',
                '        print("fib(" + i + ") = " + fib(i));',
                '    }',
                '}',
                '',
                'main();'
            ].join('\n'),

            fizzbuzz: [
                '// FizzBuzz',
                'fn fizzbuzz(n) {',
                '    for (let i = 1; i <= n; i = i + 1) {',
                '        if (i % 15 == 0) {',
                '            print("FizzBuzz");',
                '        } else if (i % 3 == 0) {',
                '            print("Fizz");',
                '        } else if (i % 5 == 0) {',
                '            print("Buzz");',
                '        } else {',
                '            print(i);',
                '        }',
                '    }',
                '}',
                '',
                'fn main() {',
                '    fizzbuzz(30);',
                '}',
                '',
                'main();'
            ].join('\n'),

            async: [
                '// Async/Await example',
                'import { sleep } from "@stdlib/time";',
                '',
                'async fn fetch_data(id) {',
                '    print("Fetching data " + id + "...");',
                '    sleep(0.5); // seconds in hemlock!',
                '    return "Data from " + id;',
                '}',
                '',
                'async fn main() {',
                '    let tasks = [',
                '        spawn(fetch_data, "A"),',
                '        spawn(fetch_data, "B"),',
                '        spawn(fetch_data, "C")',
                '    ];',
                '',
                '    for (task in tasks) {',
                '        let result = await task;',
                '        print("Got: " + result);',
                '    }',
                '',
                '    print("All done!");',
                '}',
                '',
                'main();'
            ].join('\n'),

            json: [
                '// JSON parsing',
                'import { parse, stringify } from "@stdlib/json";',
                '',
                'fn main() {',
                '    let data = {',
                '        name: "Hemlock",',
                '        version: "1.6.4",',
                '        features: ["fast", "safe", "fun"],',
                '        config: {',
                '            debug: true,',
                '            threads: 4',
                '        }',
                '    };',
                '',
                '    let json_str = stringify(data);',
                '    print("Serialized:");',
                '    print(json_str);',
                '    print("");',
                '',
                '    let parsed = parse(json_str);',
                '    print("Parsed name: " + parsed["name"]);',
                '    print("Features: " + parsed["features"]);',
                '}',
                '',
                'main();'
            ].join('\n')
        };

        // DOM elements
        const editor = document.getElementById('editor');
        const highlight = document.getElementById('highlight');
        const lineNumbers = document.getElementById('line-numbers');
        const output = document.getElementById('output');
        const runBtn = document.getElementById('run-btn');
        const checkBtn = document.getElementById('check-btn');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const versionInfo = document.getElementById('version-info');
        const examplesBtn = document.getElementById('examples-btn');
        const examplesMenu = document.getElementById('examples-menu');

        // State
        let isRunning = false;

        // Syntax highlighting
        function updateHighlight() {
            // Add trailing newline to prevent scrolling issues
            const code = editor.value + '\n';
            highlight.innerHTML = Highlighter.highlight(code);

            // Update line numbers
            const lineCount = code.split('\n').length;
            const lines = [];
            for (let i = 1; i <= lineCount; i++) {
                lines.push(i);
            }
            lineNumbers.innerHTML = lines.join('\n');
        }

        // Sync scroll between editor and highlight
        function syncScroll() {
            highlight.scrollTop = editor.scrollTop;
            highlight.scrollLeft = editor.scrollLeft;
            lineNumbers.scrollTop = editor.scrollTop;
        }

        // Fetch version info on load
        async function fetchVersion() {
            try {
                const res = await fetch(`${API_URL}/version`);
                const data = await res.json();
                versionInfo.textContent = `Hemlock ${data.hemlock_version} | API v${data.api_version}`;
            } catch (e) {
                statusDot.classList.add('error');
                statusText.textContent = 'API unavailable';
            }
        }

        // Set status
        function setStatus(status, isError = false, isRunning = false) {
            statusText.textContent = status;
            statusDot.classList.remove('error', 'running');
            if (isError) statusDot.classList.add('error');
            if (isRunning) statusDot.classList.add('running');
        }

        // Run code
        async function runCode() {
            if (isRunning) return;
            
            const code = editor.value;
            if (!code.trim()) {
                output.innerHTML = '<span class="output-info">No code to run</span>';
                return;
            }

            isRunning = true;
            runBtn.disabled = true;
            checkBtn.disabled = true;
            setStatus('Running...', false, true);
            output.innerHTML = '<span class="output-info">Executing...</span>';

            try {
                const res = await fetch(`${API_URL}/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });

                const data = await res.json();
                
                let html = '';
                
                if (data.stdout) {
                    html += `<span class="output-stdout">${escapeHtml(data.stdout)}</span>`;
                }
                
                if (data.stderr) {
                    if (html) html += '\n';
                    html += `<span class="output-stderr">${escapeHtml(data.stderr)}</span>`;
                }
                
                if (!data.stdout && !data.stderr) {
                    html = '<span class="output-info">(no output)</span>';
                }
                
                // Add execution info
                html += '\n\n';
                if (data.timed_out) {
                    html += `<span class="output-error">‚è± Execution timed out</span>\n`;
                }
                if (data.truncated) {
                    html += `<span class="output-info">‚ö† Output was truncated</span>\n`;
                }
                
                const statusClass = data.success ? 'output-success' : 'output-error';
                const statusIcon = data.success ? '‚úì' : '‚úó';
                html += `<span class="${statusClass}">${statusIcon} Exit code: ${data.exit_code}</span>`;
                html += `<span class="output-info"> | ${data.execution_time_ms}ms</span>`;
                
                output.innerHTML = html;
                setStatus(data.success ? 'Success' : 'Error', !data.success);

            } catch (e) {
                output.innerHTML = `<span class="output-error">Failed to connect to API: ${e.message}</span>`;
                setStatus('API Error', true);
            } finally {
                isRunning = false;
                runBtn.disabled = false;
                checkBtn.disabled = false;
            }
        }

        // Check syntax
        async function checkSyntax() {
            if (isRunning) return;
            
            const code = editor.value;
            if (!code.trim()) {
                output.innerHTML = '<span class="output-info">No code to check</span>';
                return;
            }

            setStatus('Checking...', false, true);

            try {
                const res = await fetch(`${API_URL}/check`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });

                const data = await res.json();
                
                if (data.valid) {
                    output.innerHTML = '<span class="output-success">‚úì Syntax OK</span>';
                    setStatus('Valid');
                } else {
                    output.innerHTML = `<span class="output-error">${escapeHtml(data.errors)}</span>`;
                    setStatus('Syntax Error', true);
                }

            } catch (e) {
                output.innerHTML = `<span class="output-error">Failed to connect to API: ${e.message}</span>`;
                setStatus('API Error', true);
            }
        }

        // Load example
        function loadExample(name) {
            if (EXAMPLES[name]) {
                editor.value = EXAMPLES[name];
                updateHighlight();
                examplesMenu.classList.remove('show');
                output.innerHTML = '<span class="output-info">Example loaded. Press Run to execute...</span>';
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Event listeners
        runBtn.addEventListener('click', runCode);
        checkBtn.addEventListener('click', checkSyntax);

        // Syntax highlighting events
        editor.addEventListener('input', updateHighlight);
        editor.addEventListener('scroll', syncScroll);

        // Keyboard shortcuts
        editor.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey && e.key === 'Enter') {
                e.preventDefault();
                checkSyntax();
            } else if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                runCode();
            }
            // Tab handling
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                editor.value = editor.value.substring(0, start) + '    ' + editor.value.substring(end);
                editor.selectionStart = editor.selectionEnd = start + 4;
            }
        });

        // Examples dropdown
        examplesBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            examplesMenu.classList.toggle('show');
        });

        document.addEventListener('click', () => {
            examplesMenu.classList.remove('show');
        });

        examplesMenu.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                loadExample(btn.dataset.example);
            });
        });

        // Initialize
        fetchVersion();
        updateHighlight();
    </script>
</body>
</html>
